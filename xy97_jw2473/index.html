
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <title>BEST TAB</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <link href="../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet"> -->

    <!-- Custom styles for this template -->
    <link href="starter-template.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <!-- <script src="../../assets/js/ie-emulation-modes-warning.js"></script> -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Telepresence Vehicle</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <!-- <li class="active"><a href="#">Home</a></li>-->
            <li><a href="#intro">Introduction</a></li>
            <li><a href="#obj">Project Objective</a></li>
            <li><a href="#setup">Setup</a></li>
            <li><a href="#design">Design</a></li>
            <li><a href="#testing">Testing</a></li>
            <li><a href="#result">Result</a></li>
            <li><a href='#conclusion'>Conclusion</a></li>
            <li><a href="#code">Code</a></li>
            <li><a href="#dist">Work Distribution</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">


      <div class="starter-template">
        <h1>Telepresence Vehicle</h1>
        <p class="lead">Motion controlled vehicle with a camera!</p><br><p>A Project By Xiaoyu Yan (xy97) and Ji Wu (jw2473)</p>
      </div>

      <hr>
      <div class="center-block" >
          <p>
            <iframe width="640" height="360"  src="https://www.youtube-nocookie.com/embed/EladGMzbRYc" frameborder="0" 
            allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        
          <h4 style="text-align:center;">Demonstration Video</h4>
        </p>
      </div>

      <hr id="intro">

      <div style="text-align:center;">
              <h2>Introduction</h2>
              <p style="text-align: left;padding: 0px 30px;">
                    <figure ALIGN=CENTER>
                            <img src="pics/IMG_1210.jpg"
                            width="560"/>
                            <font size="2">
                              <figcaption> <b>Our Vehicle!</b>
                              </figcaption>
                            </font>
                          </figure>

                        <p ALIGN=LEFT style="font-size:16px">
                          For our final project, we build a vehicle system that can be controlled remotely as long as there is
                           wifi. The vehicle has a built in camera that transmits the video feed to the user at a base station. 
                           The user uses motion control from the base station to remotely control the vehicle. This project was 
                           inspired by remote control drones and vehicles. We wanted a way to remotely control a vehicle when 
                           users don’t have sight of the vehicle. As a result of this project, we were able to have a controller communicate with the vehicle by 
                           exchanging IP addresses for requests over wifi. The controller contains a sensor that captures motion data for vehicle control 
                           and then sends that data to the robot using socket UDP and wifi. The vehicle then receives commands transmitted from the 
                           controller and move accordingly. The user can see through the vehicle with an onboard camera that host a video stream using wifi.
                            The stream is displayed on the controller in a user friendly way using Pygame. The system is robust enough to work with dynamic 
                            IP addresses given that the controller and robot both connect to the same wifi and already recognized the wifi. The video
                             stream can reconnect if wifi connection is temporarily broken. Due to its reliability on wifi to function, this vehicle can only
                              be used in locations with wifi connection, which is likely indoors. 
                          <br><br>
                          We enjoyed working with the technology involved in working on a remote controlled vehicle from the ground
                           up. The concept for this project isn’t anything new; remote control
                           vehicles and drones are already used today with radio control and onboard camera that connects to wifi.
                            The uses of these devices are for exploration of environments too hostile or inaccessible to humans 
                            which involve both scientific and military explorations. While the development of autonomous vehicles 
                            is ongoing and their reliability is increasing every year, remote control vehicles can still find 
                            use today with a human in control for complicated or important tasks, especially if real time control 
                            is possible. This also avoids vehicle ethics which is another huge topic. This system can have practical uses in helping disabled 
   people to engage in <a href="https://metro.co.uk/2018/11/30/cafe-staffed-by-robots-controlled-by-paralysed-people-opens-its-doors-8194062/" >
    physical tasks</a> remotely which can help increase employment of disabled people.
</p>
            </p>
      </div>

    <hr id='obj'>

      <div class="row">
          <div class="col-md-4" style="text-align:center;">
          <img class="img-rounded" src="pics/IMG_1215.jpg" alt="Generic placeholder image" width="240" height="240">
          </div>
          <div class="col-md-8" style="font-size:18px;">
          <h2>Project Objectives:</h2>
          <ul>
              <li>Get motion reading from accelerometer and send reading to another Raspberry Pi.
                </li>
                <li>Move vehicle according to accelerometer controls 
                    </li>
            <li>Send camera images from one Raspberry Pi to another with minimal latency.
                </li>
            <li>Implement a vehicle system that supports robust remote control and requires limited user setup. 

                </li>
          </ul>
          </div>
      </div>



<hr id='setup'>
<div style="text-align:center;">
    <h2>Project Setup</h2>
<p ALIGN=LEFT style="font-size:16px">
For this project, we used two Raspberry Pi 3B’s (RPi). One for the remote controller otherwise known as the base station and the other on the vehicle that serves as the vehicle “brain”. The project also requires additional peripherals such as:

</p>

<ol ALIGN=LEFT style="font-size:16px">
        <li>RPi camera V2
          </li>
          <li>built-in bluetooth
              </li>
      <li>BNO055 Absolute Orientation sensor
          </li>
      <li>onboard wifi</li>
      <li>PWM servos</li>
    </ol>
    <p ALIGN=LEFT style="font-size:16px">
    The coding language for this project is Python 3.5.
    Before any project, make sure that the RPi is updated by running. 
    <br>
    <code>Sudo apt-get update
          <br>  Sudo apt-get upgrade
            </code>
            <br>
This project was done on the Raspbian Linux Stretch version. However, the linux kernel updates constantly and the current version will change over time. 
<br><br>
The RPi camera library support can be downloaded using:
<br>
<code>sudo apt-get install python-picamera python3-picamera </code>
<br>  
We also want to enable the Picamera by using <code>sudo raspi-config</code> and enabling the Picamera in the settings.
<br><br>
To use the bluetooth on the RPi, we used the Blue Dot library handle communication between two RPi 3’s with built in bluetooth. They can be installed by entering:
<br>
<code>sudo apt install python3-dbus</code>
<br>
<code>sudo pip3 install bluedot</code>
<br><br>
We also made extensive use of RPI.GPIO library to generate PWM signals to control the servos and to receive input from buttons on the PiTFT. The can be installed using:
<br><code>pip install RPi.GPIO</code> 
<br>or
<br><code>sudo apt-get install python-rpi.gpio python3-rpi.gpio</code>
<br><br>The base station use Pygame to display camera feed. Pygame should already be installed on the RPi
<br>To process the camera images and compress it on the server, we used opencv and numpy. 
These libraries are also used to decode the camera feed on the receiving end and manipulate the feed. 
They can be installed using:
<br><code>pip install opencv-python</code>
<br>or 
<br><code>sudo apt-get install libopencv-dev python-opencv</code>
<br><br>We used serial communications for sending data between the base station and the sensor. 
We therefore must enable RPi’s serial interface by once again going to <code>raspi-config</code>.
 In the same location, we also disabled console login using serial to prevent it from conflicting with our serial device. 

 Next we install the BNO055 Adafruit library by using:
<br>
<pre ALIGN=LEFT><code>
cd ~
git clone https://github.com/adafruit/Adafruit_Python_BNO055.git
cd Adafruit_Python_BNO055
sudo python setup.py install
</code>
</pre>
<p ALIGN=LEFT style="font-size:16px">
This library greatly sped up our development with the BNO055 sensor and data gathering.</p>
</p>
</div>


    <!DOCTYPE html>
    <html>
    <head>
    <style>
    * {
        box-sizing: border-box;
    }
    
    .column {
        float: left;
        width: 50%;
        padding: 5px;
    }
    .column3 {
        float: left;
        width: 33%;
        padding: 5px;
    }
    
    /* Clearfix (clear floats) */
    .row::after {
        content: "";
        clear: both;
        display: table;
    }
    </style>
    </head>
    <body>

    <hr id='design'>
    
      <div style="text-align:center;font-size:16px">
              <h2>Design</h2>
                <h4><b>Bluetooth IP Address Exchange</b></h4>
              <p ALIGN=LEFT>
                   
                Initially, we expected to have a static IP for the controller so we can simply handle the requests from the controller side. However, sending packets to a specific public address is not permitted by the network of the college, so we turn to setting up all metadata over bluetooth when rebooting. Additionally, using wifi means that IP address can change per connection to said wifi which means that IP address from connection on one day may be different from connection on the next day. Thus, to avoid hardcoding the IP address of the RPI’s everytime we turn them on, we must explore ways to use any permanent properties of the RPi’s. 
<br><br>
Enter bluetooth and MAC address!  Each RPi comes with a permanent MAC address that we can use!
<br><br>
The Raspberry Pi 3b conveniently contains built in bluetooth which we can use to communicate between to RPi’s and send a string containing the IP address. To make this happen, we used the Python Blue Dot library. First we must pair the two RPi’s. This can be done in several ways: one way is using the bluetooth controller by running bluetoothtcl on the terminal and running discoverable on. The controller gives us the MAC address of the RPi we are using which we can use on the other RPi to pair. This can be done using connect mac address to pair the devices. One can use paired-devices to check if the pairing is successful.
<br><br>
Once the pairing is done, we can test if bluetooth works with sending a string using BluetoothServer and BluetoothClient classes. These classes use RFCOMM serial to send data to a server. We originally tried to use this communication method by using pyserial and then socket for bluetooth communication before we discovered this library which did what we envisioned.
<br><br>
To send IP’s, we first used Python’s subprocess library to send and record terminal commands to the RPi and then save the IP as a string. To get IP address, we used <code>hostname -I</code>. To get MAC address, we used <code>hcitool dev | grep hci0</code>, where hci0 is our bluetooth device. The Blue Dot library allows us to set up a client connecting to the specific MAC address of the server. This part is hardcoded where we ran the above command and obtained the MAC address. The vehicle will then attempt a connection to the server hosted by the base station and repeatedly send its IP address until it receives a response from the server. The response is the base station’s IP address. This is a blocking function where the system will not continue until messages are exchanged. Currently, we did not implement error checking so the bluetooth will unblock if any message is exchanged. 
<br><br>
This was a great solution suggested by our professor to get around the non static IP problem with wifi. Not needed to find IP and manually enter it for both the vehicle and base station means less maintenance on the user’s side to get this system started. Once the bluetooth is connected and IP addresses exchanged, we can completely shut off bluetooth and utilize wifi to send data between two RPi’s.
<br><br>

<div class="row" style="text-align: center">
        <div class="column">
          <img src="pics/blue.PNG" alt="Snow" style="width:50%"><font size="2">
                <figcaption> <b>Bluetooth FSM for Base Station</b>
                </figcaption>
              </font>
        </div>
        <div class="column">
          <img src="pics/blue2.PNG" alt="Forest" style="width:50%">
          <font size="2">
                <figcaption> <b>Bluetooth FSM for Vehicle</b>
                </figcaption>
        </div>

      </div>
<p ALIGN=LEFT style="font-size: 16px">Above contains the state diagrams for bluetooth and IP exchange. If no response or messages, both 
systems block and wait until messages recieved. The base station will get the message first and then send the response.</p>
</p>        
              <figure ALIGN=CENTER>
                <img src="pics/bluetooth.gif"
                width="560"/>
                <font size="2">
                  <figcaption> <b>Inital Startup of our System</b>
                  </figcaption>
                </font>
              </figure>
<br>
<p ALIGN=LEFT style="font-size: 16px">We also added a little GUI to show that the system is attempting to swap IP addresses. This helps
user experience and allows us to see if the device is blocking on the bluetooth.</p>

<h4><b>BNO055 Absolute Orientation Sensor</b></h4>

<figure ALIGN=CENTER>
        <img src="pics/s2.PNG"
        width="560"/>
        <font size="2">
          <figcaption> <b>Schematic of BNO055 Sensor to RPi</b>
          </figcaption>
        </font>
      </figure>

      <p ALIGN=LEFT style="font-size: 16px">  The BNO055 Absolute Orientation Sensor is a combination of sensors including an accelerometer, gyroscope, and magnetometer. The main reason we used the sensor was because we already own one and didn’t need to order it. One only needs the gyroscope to detect the turns of the steering wheel, thus cheaper alternatives are definitely available. The sensor itself abstracts many of the mathematics behind calculation of orientation. We used the sensor to poll for the movement of the steering wheel. Since the I2C communication with the RPi contains some glitches with clock stretching, we decided to use serial communication where we set the SDA pin as TX and SCL pin as RX. We then connect to the serial pins on the RPi. We use the default ‘/dev/serial0’ as our serial port. One problem was that attempted connection with the sensor sometimes fails and returns the error code. We never figured out the reason but we ultimately solved it by using a while and try loop that repeated attempts to connect and prints erros to the terminal for inspection instead of crashing the program. We simply read the registers on the device which contains the euler data which is contained at device address 0x1A. The library sends the serial read command as a series of bytes. 
</p>

<div class="row" style="text-align: center">
        <div class="column">
          <img src="pics/IMG_1217.jpg" alt="Snow" style="width:100%"><font size="2">
                <figcaption> <b>Wiring of the BNO055 Sensor</b>
                </figcaption>
              </font>
        </div>
        <div class="column">
          <img src="pics/IMG_1206.jpg" alt="Forest" style="width:100%">
          <font size="2">
                <figcaption> <b>Wiring of the BNO055 Sensor - Alternative View</b>
                </figcaption>
        </div>

      </div>


<h3><b>Communication</b></h3>
<p ALIGN=LEFT style="font-size: 16px">
We have to handle two different means of communication for two peripherals. One for the getting vehicle camera stream to base station and the other for sending sensor data from base station to vehicle.
<br>Considering that we are not going to remotely reboot the vehicle, we set up the vehicle as passive. The vehicle handles request from any IP address, which allows us to reconnect to it after the controller is down or the connection is lost.
</p>

<h4><b>Motion Control</b></h4>

<p ALIGN=LEFT style="font-size: 16px">
Since the control signal is lightweight and non-sensitive to packet loss, we used bare UDP sockets to send and receive control 
signal. When power-on, the vehicle will keep listening for instructions from the controller. The vehicle decodes the message 
from the UDP and then moves the servos according to the readings from the sensors. The message format is in the form of 
<code>“valid:turn:heading:roll:pitch” </code> where each message is separated by a string separator “:”. 
The valid message is to check if the UDP message is valid. The turn message is for control enable which enables the user to move 
the robot using motion control. The heading, roll, and pitch have a range of 360 to represent the angles the sensor rotates by. 
For our implementation of the robot, we only used the roll and pitch values to capture if the steering wheels clockwise 
counterclockwise rotation (roll) and forward backward roll (pitch). 

</p>
<div class="row" style="text-align: center">
        <div class="column">
                <img src="pics/steerr.PNG" alt="Forest" style="width:100%">
                <font size="2">
                      <figcaption> <b>Turning Right</b>
                      </figcaption>
              </div>    
    <div class="column">
          <img src="pics/steerl.PNG" alt="Snow" style="width:100%"><font size="2">
                <figcaption> <b>Turning Left</b>
                </figcaption>
              </font>
        </div>
        
</div>
<p ALIGN=LEFT style="font-size: 16px">The above figures shows the general conttrol for turning.
    If our steering wheel rotates counterclockwise, our roll 
        value will increase, and vice versa. The pitch will increase on a forward roll and vice versa. We then need to map the roll and 
        pitch values from the sensor to the servo PWM signals to generate the desired servo rotation speed.  
        </p>
<br>
<div class="row" style="text-align: center">
        <div class="column3">
                
        <img src="pics/servo2.PNG" alt="Forest" style="width:100%">
        <font size="2">
                <figcaption> <b>Servo Clockwise</b>
                </figcaption>
        </div>
        <div class="column3"><img src="pics/servo1.PNG" alt="Snow" style="width:100%"><font size="2">
                <figcaption> <b>Servo Stop</b>
                </figcaption>
              </font>
        </div>
        <div class="column3">
          <img src="pics/servo3.PNG" alt="Forest" style="width:100%">
          <font size="2">
                <figcaption> <b>Servo Counterclockwise</b>
                </figcaption>
        </div>
</div>
<p ALIGN=LEFT style="font-size: 16px">
As we done in lab 3, the servos uses a PWM communication with a amount of high period determining the rotation and speed of the servos with a 20ms low value. As shown in the figure above, we have a window of 0.4ms to control the servo rotation and speed. We therefore must map the values of the sensors to 0.4ms. Our range is smaller because we only take into account a turn up to 50 degrees to prevent the user from turning the steering too much. The ultimate result is a vector equation where we set the servo speed based on both the pitch value and roll value multiplied by a slope value which maps the sensor values to the PWM control window. For our robot, Counterclockwise rotation from left servo and clockwise rotation from right servo means forward while clockwise rotation from both servos mean moving left and counterclockwise rotation means left movement.  
The general equation for calculating the servo movement based on all these information is:<br>
<code >left_time = stop_time + rslope * roll - pslope * pitch</code><br>
     <code>   right_time = stop_time + rslope * roll + pslope * pitch </code><br>
     where stop time is 1.5ms and left_time and right_time are bounded into a value between 1.3 and 1.5. Pslope and rslope are 
     a function of the maximum pitch and roll values respectively where we map the range bounded by the max values to the 0.4ms range 
     for the servo control. Through testing, we discovered that having pslope = 2 * rslope is actually better for control of the 
     vehicle to prioritize moving forward as oppose to turning.
</p>


<div class="row" style="text-align: center">
        <div class="column">
          <img src="pics/IMG_1209.jpg" alt="Snow" style="width:100%"><font size="2">
                <figcaption> <b>Wiring of the Servos</b>
                </figcaption>
              </font>
        </div>
        <div class="column">
          <img src="pics/s1.PNG" alt="Forest" style="width:100%">
          <font size="2">
                <figcaption> <b>Schematic of Servos</b>
                </figcaption>
        </div>
</div>
<p ALIGN=LEFT style="font-size: 16px">Above is the wiring of the servos to the GPIO pins. We use a 1k resistor between the
GPIO and servo control to keep the current down and as an extra safety measure even if the RPi has built in pull up resistors. 
The switch facilitates testing and saves the energies of the AAA batteries that are mounted under the robot.</p>
<br>


<h4><b>Realtime Streaming</b></h4>
<p ALIGN=LEFT style="font-size: 16px">
Our application requires minimum latency for video streaming in order for safety. We set up a simple HTTP server on the 
vehicle which responds to any request with a stream of encoded image. The response starts with a header that specifies the 
response as “no-cache” and the data type as “multipart”, followed by a endless stream of JPEG format images bounded by 
<code>“\xff\xd8”</code> 
and <code>“\xff\xd9”</code>. 
The images are extracted from the output byte stream of picamera by redirecting the stream to an custom class 
with a “write” method that keeps searching for <code>“\xff\xd8”</code> pattern. When a complete frame has been written, 
a condition variable 
is triggered and tells the main loop to proceed.
<br><br>
When the controller is getting the requested data stream, images are extracted from the content by searching for boundary patterns and decoded and displayed on the touch screen using pygame. To make the system robust, we handled timeout and broken pipe exception from the controller side by sending periodic requests for reconnection.
<br><br>
Before we turned to HTTP, we also tried using bare TCP protocol. However, the frame rate remained pretty low (around 3 - 5) no matter how we reduced the image size and bit rate. We suspect that the maximum number of requests from a single device that can be handled by the router is around 3-5 per second. So we cannot get over the limit by simply reducing the size of the response. In contrast, since HTTP protocol allows multipart type response, we can send a stream of many images without adding more work load to the router and thus increase the frame rate. For motion control there is a similar limit of 5 instructions per second. However, since it is already satisfying for out application, we did not set up a seperate server to handle the communication of instructions.

</p>



<div class="row" style="text-align: center">
        <div class="column">
          <img src="pics/DiagramBaseStation.PNG" alt="Snow" style="width:100%"><font size="2">
                <figcaption> <b>FSM for Base Station</b>
                </figcaption>
              </font>
        </div>
        <div class="column">
          <img src="pics/DiagramForRobot.PNG" alt="Forest" style="width:90%">
          <font size="2">
                <figcaption> <b>FSM for Vehicle</b>
                </figcaption>
        </div>

      </div>

      <p ALIGN=LEFT style="font-size: 16px">Above contains the control diagram for the entire system.
    We can see that both have very similar initial structure but diverges after IP exchange. We execute multiple independent tasks
in our system so we can perform these tasks in parallel using threads which can distribute the workload over multiple cores.
<br><br>
The system itself is not entirely independent and that we have shared variables among threads since behavior of some of the threads depends on
results obtained by others. We did not need to implement any major synchronization however since we initialized the shared variables and
threads such that there is always one writer and reader. The only condition variable we used was for camera streaming.</p>           
</div>



    <hr id='testing'>

      <div style="text-align:center;">
              <h2>Testing</h2>
              
<p style="text-align: left;padding: 0px 30px;">

</p>
              <iframe width="640" height="360" src="https://www.youtube.com/embed/HiY0g6ddt2g?rel=0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

      </div>

    <hr id='result'>

      <div style="text-align:center;">
              <h2>Result</h2>
 <p style="text-align: left;padding: 0px 30px;">
                </p>              
                    </div>

<hr id='conclusion'>
<div style='text-align:center'>
<h2>Conclusions</h2>

<p ALIGN=LEFT style="font-size: 16px">
We succeeded in building a robust plug-and-use remote driving system which handles latency and loss of connection. We achieved our goals even if the technologies we planned to use did not work out as expected. 
<br><br>First, we tried out different types of wireless communication. Bluetooth is the first to be discarded and only used for transmitting metadata because of its limited range. Then we briefly used lora radio, which can cover over long range but has a narrow bandwidth and is not capable of video streaming. As for WiFi communication, which we finally used, bare UDP resulted in serious packet loss and bare TCP connection suffers from high latency and unstable framerate because each packet has to be re-routed. So our final choice is to set up an HTTP server on the vehicle, which perfectly works out with controlled latency and a stable framerate of 24 frames per second.
</p>
<h4><b>Future Work</b></h4>

<p ALIGN=LEFT style="font-size: 16px">
We would like to add a auto-driving mode for the vehicle so that it will try to return to the place it starts with 
backtracking on its movement history after losing reconnection with the controller. Due to development on autonomous robots, we
believe integrating automony is a natural next step for our vehicle. Another idea is to use openCV library for image processing
to detect if walls are too close and stop the robot or have the robot follow a line using openCV. Computer vision and machine 
learning has huge research potential for our robot. 
<br><br>
On a more immediate note, we also had extra room but not enough time to implement extra vehicle controls. We current only used
three of the four GPIO pins on the PiTFT. The PiTFT also contains touch screen functionality which we can take advantage of by
creating touch screen menus or controls using the touch screen alone. We had motion control for our vehicle but motion control 
could have also been a possibility. The vehicle can certainly be repurposed to accomplish a specific task where we can add arms 
or microphones. The possibilities are limitless. 
</p>
</div>

    <hr id='code'>

    <div class="row"  style="text-align:center;font-size:16px">
            <h2>Code Appendix</h2>
            <p style="text-align: left;padding: 0px 30px;">
                Here contains the main code used in the system. Throughout our project, we also created many 
                modular files for testing
                various parts of the system and just seeing if something works. 
                The entire Github repository for all the code can be found 
                <a href="https://github.com/xy97cornell/ece5725/tree/master/final_project">here</a>.  
            </p>

<!-- HTML generated using hilite.me --><div ALIGN=LEFT style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0099FF; font-style: italic"># client.py</span>
<span style="color: #0099FF; font-style: italic"># 12/7/2018 </span>
<span style="color: #0099FF; font-style: italic"># Xiaoyu Yan (xy97) and Ji Wu (jw2473)</span>
<span style="color: #0099FF; font-style: italic"># Final Project - Telepresence Vehicle</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Main control file for robot. Sends its IP address to the basestation </span>
<span style="color: #0099FF; font-style: italic"># and gets basestation IP address.</span>
<span style="color: #0099FF; font-style: italic"># Receives and decodes commands from basestation and sets up a host </span>
<span style="color: #0099FF; font-style: italic"># server for the camera stream</span>
<span style="color: #0099FF; font-style: italic"># Handles servo movements to control robot movement </span>
<span style="color: #0099FF; font-style: italic">#</span>
</pre></div>
    
<details ALIGN=LEFT><summary><I>Click to see client.py</I></summary>
<!-- HTML generated using hilite.me --><div style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150</pre></td><td><pre ALIGN=LEFT style="margin: 0; line-height: 125%"><span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">RPi.GPIO</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">GPIO</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">socket</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">threading</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">cv2</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">numpy</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">np</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">picamera</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">subprocess</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">re</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">time</span>
<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">bluedot.btcomm</span> <span style="color: #006699; font-weight: bold">import</span> BluetoothClient, BluetoothAdapter
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">io</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">struct</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">socketserver</span>
<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">http</span> <span style="color: #006699; font-weight: bold">import</span> server
<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">threading</span> <span style="color: #006699; font-weight: bold">import</span> Condition
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">Robot</span> <span style="color: #0099FF; font-style: italic">#custom library</span>

GPIO<span style="color: #555555">.</span>setmode(GPIO<span style="color: #555555">.</span>BCM)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">6</span>, GPIO<span style="color: #555555">.</span>OUT)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">13</span>, GPIO<span style="color: #555555">.</span>OUT)
p1 <span style="color: #555555">=</span> GPIO<span style="color: #555555">.</span>PWM(<span style="color: #FF6600">6</span>, <span style="color: #FF6600">100000</span><span style="color: #555555">/</span><span style="color: #FF6600">2150</span>)
p2 <span style="color: #555555">=</span> GPIO<span style="color: #555555">.</span>PWM(<span style="color: #FF6600">13</span>, <span style="color: #FF6600">100000</span><span style="color: #555555">/</span><span style="color: #FF6600">2150</span>)
p1<span style="color: #555555">.</span>start(<span style="color: #FF6600">150</span><span style="color: #555555">/</span><span style="color: #FF6600">2150.0</span><span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
p2<span style="color: #555555">.</span>start(<span style="color: #FF6600">150</span><span style="color: #555555">/</span><span style="color: #FF6600">2150.0</span><span style="color: #555555">*</span><span style="color: #FF6600">100</span>)

<span style="color: #0099FF; font-style: italic">## Get IP address</span>
result <span style="color: #555555">=</span> subprocess<span style="color: #555555">.</span>run(<span style="color: #CC3300">&#39;hostname -I&#39;</span>, stdout<span style="color: #555555">=</span>subprocess<span style="color: #555555">.</span>PIPE, 
shell<span style="color: #555555">=</span><span style="color: #336666">True</span>)
result <span style="color: #555555">=</span> result<span style="color: #555555">.</span>stdout<span style="color: #555555">.</span>decode(<span style="color: #CC3300">&#39;utf-8&#39;</span>)
client_IP <span style="color: #555555">=</span> re<span style="color: #555555">.</span>split(<span style="color: #CC3300">&#39; |</span><span style="color: #CC3300; font-weight: bold">\n</span><span style="color: #CC3300">&#39;</span>, result)[<span style="color: #FF6600">0</span>]
<span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;client_IP: &quot;</span><span style="color: #555555">+</span>client_IP)


PORT1 <span style="color: #555555">=</span> <span style="color: #FF6600">5000</span>
BUFFER_SIZE <span style="color: #555555">=</span> <span style="color: #FF6600">1024</span>
connected <span style="color: #555555">=</span> <span style="color: #336666">True</span>
run <span style="color: #555555">=</span> <span style="color: #336666">True</span>
<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">StreamingOutput</span>(<span style="color: #336666">object</span>):
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__init__</span>(<span style="color: #336666">self</span>):
        <span style="color: #336666">self</span><span style="color: #555555">.</span>frame <span style="color: #555555">=</span> <span style="color: #336666">None</span>
        <span style="color: #336666">self</span><span style="color: #555555">.</span>buffer <span style="color: #555555">=</span> io<span style="color: #555555">.</span>BytesIO()
        <span style="color: #336666">self</span><span style="color: #555555">.</span>condition <span style="color: #555555">=</span> Condition()

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">write</span>(<span style="color: #336666">self</span>, buf):
        <span style="color: #006699; font-weight: bold">if</span> buf<span style="color: #555555">.</span>startswith(b<span style="color: #CC3300">&#39;</span><span style="color: #CC3300; font-weight: bold">\xff\xd8</span><span style="color: #CC3300">&#39;</span>):
            <span style="color: #336666">self</span><span style="color: #555555">.</span>buffer<span style="color: #555555">.</span>truncate()
            <span style="color: #006699; font-weight: bold">with</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>condition:
                <span style="color: #336666">self</span><span style="color: #555555">.</span>frame <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>buffer<span style="color: #555555">.</span>getvalue()
                <span style="color: #336666">self</span><span style="color: #555555">.</span>condition<span style="color: #555555">.</span>notify_all()
            <span style="color: #336666">self</span><span style="color: #555555">.</span>buffer<span style="color: #555555">.</span>seek(<span style="color: #FF6600">0</span>)
        <span style="color: #006699; font-weight: bold">return</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>buffer<span style="color: #555555">.</span>write(buf)

<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">StreamingHandler</span>(server<span style="color: #555555">.</span>BaseHTTPRequestHandler):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Streaming video to HTTP server</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">do_GET</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">if</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>path <span style="color: #555555">==</span> <span style="color: #CC3300">&#39;/&#39;</span>:
            <span style="color: #336666">self</span><span style="color: #555555">.</span>send_response(<span style="color: #FF6600">200</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Age&#39;</span>, <span style="color: #FF6600">0</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Cache-Control&#39;</span>, <span style="color: #CC3300">&#39;no-cache, private&#39;</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Pragma&#39;</span>, <span style="color: #CC3300">&#39;no-cache&#39;</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Content-Type&#39;</span>, 
            <span style="color: #CC3300">&#39;multipart/x-mixed-replace; boundary=FRAME&#39;</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>end_headers()
            <span style="color: #006699; font-weight: bold">try</span>:
                <span style="color: #006699; font-weight: bold">while</span> <span style="color: #336666">True</span>:
                    <span style="color: #006699; font-weight: bold">with</span> output<span style="color: #555555">.</span>condition:
                        output<span style="color: #555555">.</span>condition<span style="color: #555555">.</span>wait()
                        frame <span style="color: #555555">=</span> output<span style="color: #555555">.</span>frame
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>wfile<span style="color: #555555">.</span>write(b<span style="color: #CC3300">&#39;--FRAME</span><span style="color: #CC3300; font-weight: bold">\r\n</span><span style="color: #CC3300">&#39;</span>)
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Content-Type&#39;</span>, <span style="color: #CC3300">&#39;image/jpeg&#39;</span>)
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>send_header(<span style="color: #CC3300">&#39;Content-Length&#39;</span>, <span style="color: #336666">len</span>(frame))
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>end_headers()
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>wfile<span style="color: #555555">.</span>write(frame)
                    <span style="color: #336666">self</span><span style="color: #555555">.</span>wfile<span style="color: #555555">.</span>write(b<span style="color: #CC3300">&#39;</span><span style="color: #CC3300; font-weight: bold">\r\n</span><span style="color: #CC3300">&#39;</span>)
            <span style="color: #006699; font-weight: bold">except</span> <span style="color: #CC0000; font-weight: bold">Exception</span> <span style="color: #006699; font-weight: bold">as</span> e:
                <span style="color: #006699; font-weight: bold">pass</span>


<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">StreamingServer</span>(socketserver<span style="color: #555555">.</span>ThreadingMixIn, server<span style="color: #555555">.</span>HTTPServer):
    allow_reuse_address <span style="color: #555555">=</span> <span style="color: #336666">True</span>
    daemon_threads <span style="color: #555555">=</span> <span style="color: #336666">True</span>



<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">data_received</span>(data):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Callback function for bluetooth data received </span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> host_IP
    <span style="color: #006699; font-weight: bold">global</span> flag
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;host_IP: &#39;</span> <span style="color: #555555">+</span> data)
    host_IP <span style="color: #555555">=</span> data
    flag <span style="color: #555555">=</span> <span style="color: #336666">False</span>
    
<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">sendIP</span>():
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Repeatedly sends the string containing IP address to target. </span>
<span style="color: #CC3300; font-style: italic">    Requires the MAC address of the target to be hardcoded.</span>
<span style="color: #CC3300; font-style: italic">    Receives back IP address from target and saves it for UDP </span>
<span style="color: #CC3300; font-style: italic">    connection</span>
<span style="color: #CC3300; font-style: italic">    Blocks until we connect with base station </span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> flag
    flag <span style="color: #555555">=</span> <span style="color: #336666">True</span>
    c <span style="color: #555555">=</span> BluetoothClient(<span style="color: #CC3300">&#39;B8:27:EB:2A:46:91&#39;</span>, data_received, 
    power_up_device<span style="color: #555555">=</span><span style="color: #336666">True</span>)
    <span style="color: #006699; font-weight: bold">while</span> flag:
        c<span style="color: #555555">.</span>send(client_IP)
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">1</span>)
    c<span style="color: #555555">.</span>disconnect()

sendIP()
<span style="color: #0099FF; font-style: italic">### Connection good!! Start everything else</span>
s1 <span style="color: #555555">=</span> socket<span style="color: #555555">.</span>socket(socket<span style="color: #555555">.</span>AF_INET, socket<span style="color: #555555">.</span>SOCK_DGRAM)
s1<span style="color: #555555">.</span>bind((client_IP, PORT1))
s1<span style="color: #555555">.</span>setblocking(<span style="color: #FF6600">0</span>)

camera <span style="color: #555555">=</span> picamera<span style="color: #555555">.</span>PiCamera(resolution<span style="color: #555555">=</span>(<span style="color: #FF6600">320</span>, <span style="color: #FF6600">240</span>), framerate<span style="color: #555555">=</span><span style="color: #FF6600">24</span>)
output <span style="color: #555555">=</span> StreamingOutput()
camera<span style="color: #555555">.</span>start_recording(output, format<span style="color: #555555">=</span><span style="color: #CC3300">&#39;mjpeg&#39;</span>)
address <span style="color: #555555">=</span> (<span style="color: #CC3300">&#39;&#39;</span>, <span style="color: #FF6600">8000</span>)
server <span style="color: #555555">=</span> StreamingServer(address, StreamingHandler)

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">func</span>(server):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Threading function for hosting camera stream</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    server<span style="color: #555555">.</span>serve_forever()


thread <span style="color: #555555">=</span> threading<span style="color: #555555">.</span>Thread(target<span style="color: #555555">=</span>func, args<span style="color: #555555">=</span>(server,))
thread<span style="color: #555555">.</span>setDaemon <span style="color: #555555">=</span> <span style="color: #336666">True</span>
thread<span style="color: #555555">.</span>start()

robot <span style="color: #555555">=</span> Robot<span style="color: #555555">.</span>Robot()
t <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
<span style="color: #006699; font-weight: bold">while</span> run:
    <span style="color: #006699; font-weight: bold">try</span>:
        data <span style="color: #555555">=</span> s1<span style="color: #555555">.</span>recv(BUFFER_SIZE)
        data <span style="color: #555555">=</span> data<span style="color: #555555">.</span>decode(<span style="color: #CC3300">&#39;utf-8&#39;</span>)
        robot<span style="color: #555555">.</span>command(data)
        <span style="color: #006699; font-weight: bold">print</span>(data)
        t <span style="color: #555555">=</span> time<span style="color: #555555">.</span>time() <span style="color: #555555">+</span> <span style="color: #FF6600">1</span>
        
    <span style="color: #006699; font-weight: bold">except</span> BlockingIOError:
        data <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;0:0:0:0:0&quot;</span> <span style="color: #0099FF; font-style: italic">#sends invalid data to stop robot</span>
        <span style="color: #006699; font-weight: bold">if</span> time<span style="color: #555555">.</span>time()<span style="color: #555555">&gt;</span>t:
            robot<span style="color: #555555">.</span>command(data) 
</pre></td></tr></table></div>
      
</details>


<!-- HTML generated using hilite.me --><div ALIGN=LEFT style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0099FF; font-style: italic"># mainserver_v2.py</span>
<span style="color: #0099FF; font-style: italic"># 12/7/2018 </span>
<span style="color: #0099FF; font-style: italic"># Xiaoyu Yan (xy97) and Ji Wu (jw2473)</span>
<span style="color: #0099FF; font-style: italic"># Final Project - Telepresence Vehicle</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Main control for the basestation. Handles communication with robot </span>
<span style="color: #0099FF; font-style: italic"># through bluetooth, then receives camera data from the robot. Also </span>
<span style="color: #0099FF; font-style: italic"># displays the camera images to the PiTFT and any GUI.</span>
<span style="color: #0099FF; font-style: italic"># </span>
</pre></div>
    
<details ALIGN=LEFT><summary><I>Click to see mainserver_v2.py</I></summary>
<!-- HTML generated using hilite.me --><div style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">socket</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">sys</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">subprocess</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">re</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">time</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">threading</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">cv2</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">numpy</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">np</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">requests</span>
<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">PIL</span> <span style="color: #006699; font-weight: bold">import</span> Image
<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">bluedot.btcomm</span> <span style="color: #006699; font-weight: bold">import</span> BluetoothServer, BluetoothAdapter

<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">RPi.GPIO</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">GPIO</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">pygame</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">os</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">bno</span> <span style="color: #0099FF; font-style: italic">#custom module</span>

os<span style="color: #555555">.</span>putenv(<span style="color: #CC3300">&#39;SDL_VIDEODRIVER&#39;</span>, <span style="color: #CC3300">&#39;fbcon&#39;</span>) <span style="color: #0099FF; font-style: italic"># Display on piTFT</span>
os<span style="color: #555555">.</span>putenv(<span style="color: #CC3300">&#39;SDL_FBDEV&#39;</span>, <span style="color: #CC3300">&#39;/dev/fb1&#39;</span>) 
os<span style="color: #555555">.</span>putenv(<span style="color: #CC3300">&#39;SDL_MOUSEDRV&#39;</span>, <span style="color: #CC3300">&#39;TSLIB&#39;</span>) <span style="color: #0099FF; font-style: italic">#setup mouse in pygame</span>
os<span style="color: #555555">.</span>putenv(<span style="color: #CC3300">&#39;SDL_MOUSEDEV&#39;</span>, <span style="color: #CC3300">&#39;/dev/input/touchscreen&#39;</span>) <span style="color: #0099FF; font-style: italic">#touchscreen as mouse</span>



result <span style="color: #555555">=</span> subprocess<span style="color: #555555">.</span>run(<span style="color: #CC3300">&#39;hostname -I&#39;</span>, stdout<span style="color: #555555">=</span>subprocess<span style="color: #555555">.</span>PIPE, 
shell<span style="color: #555555">=</span><span style="color: #336666">True</span>)
result <span style="color: #555555">=</span> result<span style="color: #555555">.</span>stdout<span style="color: #555555">.</span>decode(<span style="color: #CC3300">&#39;utf-8&#39;</span>)
host_IP <span style="color: #555555">=</span> re<span style="color: #555555">.</span>split(<span style="color: #CC3300">&#39; |</span><span style="color: #CC3300; font-weight: bold">\n</span><span style="color: #CC3300">&#39;</span>, result)[<span style="color: #FF6600">0</span>]
<span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;host_IP: &quot;</span><span style="color: #555555">+</span>host_IP)

result <span style="color: #555555">=</span> subprocess<span style="color: #555555">.</span>run(<span style="color: #CC3300">&#39;hcitool dev|grep hci0&#39;</span>, stdout<span style="color: #555555">=</span>subprocess<span style="color: #555555">.</span>PIPE, 
shell<span style="color: #555555">=</span><span style="color: #336666">True</span>)
result <span style="color: #555555">=</span> result<span style="color: #555555">.</span>stdout<span style="color: #555555">.</span>decode(<span style="color: #CC3300">&#39;utf-8&#39;</span>)
host_mac <span style="color: #555555">=</span> re<span style="color: #555555">.</span>split(<span style="color: #CC3300">&#39; |</span><span style="color: #CC3300; font-weight: bold">\n</span><span style="color: #CC3300">|</span><span style="color: #CC3300; font-weight: bold">\t</span><span style="color: #CC3300">&#39;</span>, result)[<span style="color: #FF6600">2</span>]
<span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;host_mac: &quot;</span><span style="color: #555555">+</span>host_mac)

client_IP <span style="color: #555555">=</span> <span style="color: #CC3300">&#39;10.148.4.162&#39;</span> <span style="color: #0099FF; font-style: italic">#default Client IP</span>

code_running <span style="color: #555555">=</span> <span style="color: #336666">True</span>
turn <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>

<span style="color: #0099FF; font-style: italic">#######GPIO CALLBACK FUNCTIONS (Interrupt Handlers)############</span>
<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">GPIO22_callback</span>(channel):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    interrupt handler for GPIO17; button on piTFT</span>
<span style="color: #CC3300; font-style: italic">    Sets the control enabled bit for whether we are turning on </span>
<span style="color: #CC3300; font-style: italic">    motion controls on the robot</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">print</span> (<span style="color: #CC3300">&quot;in interrupt 22&quot;</span>)
    <span style="color: #006699; font-weight: bold">global</span> turn 
    turn <span style="color: #555555">=</span> <span style="color: #FF6600">1</span> <span style="color: #006699; font-weight: bold">if</span> turn<span style="color: #555555">==</span><span style="color: #FF6600">0</span> <span style="color: #006699; font-weight: bold">else</span> <span style="color: #FF6600">0</span>
    

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">GPIO23_callback</span>(channel):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Unused</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">print</span> (<span style="color: #CC3300">&quot;in interrupt 23&quot;</span>)
    
    
    
<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">GPIO27_callback</span>(channel):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Exits the program. Breakout button</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">print</span> (<span style="color: #CC3300">&quot;in interrupt 27&quot;</span>)
    <span style="color: #006699; font-weight: bold">global</span> code_running
    code_running <span style="color: #555555">=</span> <span style="color: #336666">False</span>
    GPIO<span style="color: #555555">.</span>cleanup()
    sys<span style="color: #555555">.</span>exit(<span style="color: #FF6600">0</span>)
    
GPIO<span style="color: #555555">.</span>setmode(GPIO<span style="color: #555555">.</span>BCM)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">22</span>, GPIO<span style="color: #555555">.</span>IN, pull_up_down<span style="color: #555555">=</span>GPIO<span style="color: #555555">.</span>PUD_UP)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">23</span>, GPIO<span style="color: #555555">.</span>IN, pull_up_down<span style="color: #555555">=</span>GPIO<span style="color: #555555">.</span>PUD_UP)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">27</span>, GPIO<span style="color: #555555">.</span>IN, pull_up_down<span style="color: #555555">=</span>GPIO<span style="color: #555555">.</span>PUD_UP)
GPIO<span style="color: #555555">.</span>add_event_detect(<span style="color: #FF6600">22</span>,GPIO<span style="color: #555555">.</span>FALLING,callback<span style="color: #555555">=</span>GPIO22_callback,
bouncetime<span style="color: #555555">=</span><span style="color: #FF6600">300</span>)
GPIO<span style="color: #555555">.</span>add_event_detect(<span style="color: #FF6600">23</span>,GPIO<span style="color: #555555">.</span>FALLING,callback<span style="color: #555555">=</span>GPIO23_callback,
bouncetime<span style="color: #555555">=</span><span style="color: #FF6600">300</span>)
GPIO<span style="color: #555555">.</span>add_event_detect(<span style="color: #FF6600">27</span>,GPIO<span style="color: #555555">.</span>FALLING,callback<span style="color: #555555">=</span>GPIO27_callback,
bouncetime<span style="color: #555555">=</span><span style="color: #FF6600">300</span>)

size <span style="color: #555555">=</span> <span style="color: #FF6600">320</span>,<span style="color: #FF6600">240</span>
screen <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>display<span style="color: #555555">.</span>set_mode(size)
pygame<span style="color: #555555">.</span>init()

pygame<span style="color: #555555">.</span>mouse<span style="color: #555555">.</span>set_visible(<span style="color: #336666">False</span>)
my_font <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>font<span style="color: #555555">.</span>Font(<span style="color: #336666">None</span>,<span style="color: #FF6600">30</span>)

COMMAND_PORT<span style="color: #555555">=</span><span style="color: #FF6600">5000</span>
CAM_PORT <span style="color: #555555">=</span> <span style="color: #FF6600">8000</span>
BUFFER_SIZE <span style="color: #555555">=</span> <span style="color: #FF6600">1024</span>
get_ip()
time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">2</span>)

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">data_received</span>(data):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Callback fuction for receiving bluetooth messages</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> client_IP
    <span style="color: #006699; font-weight: bold">global</span> flag
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;Got IP from Client! IP: &quot;</span><span style="color: #555555">+</span> <span style="color: #336666">str</span>(data))
    client_IP <span style="color: #555555">=</span> data
    flag <span style="color: #555555">=</span> <span style="color: #336666">False</span>

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">get_ip</span>():
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Receives sender IP through bluetooth</span>
<span style="color: #CC3300; font-style: italic">    Relays its IP back to the sender using send&#39;s IP that was </span>
<span style="color: #CC3300; font-style: italic">    received</span>
<span style="color: #CC3300; font-style: italic">    Also generates pygame GUI to inform user that we are looking</span>
<span style="color: #CC3300; font-style: italic">    for bluetooth.</span>
<span style="color: #CC3300; font-style: italic">    Blocks until one robot connects </span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> flag
    blue <span style="color: #555555">=</span>  BluetoothServer(data_received, power_up_device<span style="color: #555555">=</span><span style="color: #336666">True</span>)
    flag <span style="color: #555555">=</span> <span style="color: #336666">True</span>
    i <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
    <span style="color: #006699; font-weight: bold">while</span> flag:
        screen<span style="color: #555555">.</span>fill((<span style="color: #FF6600">0</span>,<span style="color: #FF6600">0</span>,<span style="color: #FF6600">0</span>))
        mytext <span style="color: #555555">=</span> <span style="color: #CC3300">&quot;Connecting to Bluetooth&quot;</span>
        
        <span style="color: #006699; font-weight: bold">if</span>(i<span style="color: #555555">==</span><span style="color: #FF6600">0</span>):
            mytext <span style="color: #555555">=</span> mytext<span style="color: #555555">+</span><span style="color: #CC3300">&#39;.&#39;</span>
        <span style="color: #006699; font-weight: bold">elif</span> (i<span style="color: #555555">==</span><span style="color: #FF6600">1</span>):
            mytext <span style="color: #555555">=</span> mytext<span style="color: #555555">+</span><span style="color: #CC3300">&#39;..&#39;</span>
        <span style="color: #006699; font-weight: bold">elif</span> (i<span style="color: #555555">==</span><span style="color: #FF6600">2</span>):
            mytext <span style="color: #555555">=</span> mytext<span style="color: #555555">+</span><span style="color: #CC3300">&#39;...&#39;</span>
        <span style="color: #006699; font-weight: bold">else</span>:
            i<span style="color: #555555">=-</span><span style="color: #FF6600">1</span>
        i<span style="color: #555555">+=</span><span style="color: #FF6600">1</span>
        text_surface <span style="color: #555555">=</span> my_font<span style="color: #555555">.</span>render(mytext,<span style="color: #336666">True</span>,(<span style="color: #FF6600">255</span>,<span style="color: #FF6600">255</span>,<span style="color: #FF6600">255</span>))
        text_surface <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>transform<span style="color: #555555">.</span>rotate(text_surface,<span style="color: #FF6600">180</span>)
        rect <span style="color: #555555">=</span> text_surface<span style="color: #555555">.</span>get_rect(center<span style="color: #555555">=</span>(<span style="color: #FF6600">160</span>, <span style="color: #FF6600">120</span>))	
        screen<span style="color: #555555">.</span>blit(text_surface,rect)
        
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">1</span>)
        pygame<span style="color: #555555">.</span>display<span style="color: #555555">.</span>flip()
    blue<span style="color: #555555">.</span>send(host_IP)
    blue<span style="color: #555555">.</span>stop()


<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">camera_receive</span>(client_IP):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Requests video feed from a server hosted by the Robot.</span>
<span style="color: #CC3300; font-style: italic">    Saves the images in an encoded array</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">while</span> code_running:
        <span style="color: #006699; font-weight: bold">try</span>: 
            r<span style="color: #555555">=</span> requests<span style="color: #555555">.</span>get(<span style="color: #CC3300">&#39;http://&#39;</span> <span style="color: #555555">+</span> client_IP <span style="color: #555555">+</span> <span style="color: #CC3300">&#39;:8000&#39;</span>, stream<span style="color: #555555">=</span><span style="color: #336666">True</span>,
            timeout<span style="color: #555555">=</span><span style="color: #FF6600">5</span>)
            <span style="color: #006699; font-weight: bold">if</span>(r<span style="color: #555555">.</span>status_code <span style="color: #555555">==</span> <span style="color: #FF6600">200</span>):
                bytes1 <span style="color: #555555">=</span> <span style="color: #336666">bytes</span>()
                <span style="color: #006699; font-weight: bold">global</span> image
                <span style="color: #006699; font-weight: bold">for</span> chunk <span style="color: #000000; font-weight: bold">in</span> r<span style="color: #555555">.</span>iter_content(chunk_size<span style="color: #555555">=</span><span style="color: #FF6600">1024</span>):
                    bytes1 <span style="color: #555555">+=</span> chunk
                    a <span style="color: #555555">=</span> bytes1<span style="color: #555555">.</span>find(b<span style="color: #CC3300">&#39;</span><span style="color: #CC3300; font-weight: bold">\xff\xd8</span><span style="color: #CC3300">&#39;</span>)
                    b <span style="color: #555555">=</span> bytes1<span style="color: #555555">.</span>find(b<span style="color: #CC3300">&#39;</span><span style="color: #CC3300; font-weight: bold">\xff\xd9</span><span style="color: #CC3300">&#39;</span>)
                    <span style="color: #006699; font-weight: bold">if</span> a <span style="color: #555555">!=</span> <span style="color: #555555">-</span><span style="color: #FF6600">1</span> <span style="color: #000000; font-weight: bold">and</span> b <span style="color: #555555">!=</span> <span style="color: #555555">-</span><span style="color: #FF6600">1</span>:
                        jpg <span style="color: #555555">=</span> bytes1[a:b<span style="color: #555555">+</span><span style="color: #FF6600">2</span>]
                        bytes1 <span style="color: #555555">=</span> bytes1[b<span style="color: #555555">+</span><span style="color: #FF6600">2</span>:]
                        image <span style="color: #555555">=</span> cv2<span style="color: #555555">.</span>imdecode(np<span style="color: #555555">.</span>fromstring(jpg, dtype<span style="color: #555555">=</span>np<span style="color: #555555">.</span>uint8), 
                        cv2<span style="color: #555555">.</span>IMREAD_COLOR)
                        image <span style="color: #555555">=</span> np<span style="color: #555555">.</span>flip(image, axis<span style="color: #555555">=</span><span style="color: #FF6600">1</span>)
        <span style="color: #006699; font-weight: bold">except</span> <span style="color: #CC0000; font-weight: bold">Exception</span> <span style="color: #006699; font-weight: bold">as</span> e:
            <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;error :{}&quot;</span><span style="color: #555555">.</span>format(e))
            time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">1</span>)

h <span style="color: #555555">=</span> <span style="color: #FF6600">0</span> <span style="color: #0099FF; font-style: italic">#global variables for BNO055 data</span>
r <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
p <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">send_command</span>():
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Sends the BNO055 data to the robot. This function is ran in a thread that</span>
<span style="color: #CC3300; font-style: italic">    regularly checks the sensor for data to send. </span>
<span style="color: #CC3300; font-style: italic">    The message is send using UDP socket. The message format is:</span>
<span style="color: #CC3300; font-style: italic">    valid:control:heading:roll:pitch</span>

<span style="color: #CC3300; font-style: italic">    valid  : if message sent is valid</span>
<span style="color: #CC3300; font-style: italic">    control: control enable</span>
<span style="color: #CC3300; font-style: italic">    heading: not used </span>
<span style="color: #CC3300; font-style: italic">    roll   : control robot direction</span>
<span style="color: #CC3300; font-style: italic">    pitch  : control robot speed and forward/backward movement</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> h,r,p
    <span style="color: #006699; font-weight: bold">while</span> code_running:
        command_server <span style="color: #555555">=</span> socket<span style="color: #555555">.</span>socket(socket<span style="color: #555555">.</span>AF_INET, socket<span style="color: #555555">.</span>SOCK_DGRAM)
        bno<span style="color: #555555">.</span>bno_init()
        <span style="color: #006699; font-weight: bold">try</span>:
            <span style="color: #006699; font-weight: bold">while</span> code_running:
                h,r,p <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>bno_poll()
                message <span style="color: #555555">=</span> <span style="color: #336666">str</span>(<span style="color: #FF6600">1</span>)<span style="color: #555555">+</span><span style="color: #CC3300">&quot;:&quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(turn)<span style="color: #555555">+</span><span style="color: #CC3300">&quot;:&quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(h)<span style="color: #555555">+</span><span style="color: #CC3300">&quot;:&quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(r)<span style="color: #555555">+</span><span style="color: #CC3300">&quot;:&quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(p)
                command_server<span style="color: #555555">.</span>sendto(message<span style="color: #555555">.</span>encode(), (client_IP, COMMAND_PORT))
                time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">0.3</span>) <span style="color: #0099FF; font-style: italic">#defines the period of when to check and send data</span>
        <span style="color: #006699; font-weight: bold">except</span> <span style="color: #CC0000; font-weight: bold">Exception</span> <span style="color: #006699; font-weight: bold">as</span> e:
            <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;error :{}&quot;</span><span style="color: #555555">.</span>format(e))
        command_server<span style="color: #555555">.</span>close()

th <span style="color: #555555">=</span> threading<span style="color: #555555">.</span>Thread(target<span style="color: #555555">=</span>camera_receive, args<span style="color: #555555">=</span>(client_IP,))
th<span style="color: #555555">.</span>setDaemon <span style="color: #555555">=</span> <span style="color: #336666">True</span>
th<span style="color: #555555">.</span>start()

command_thread <span style="color: #555555">=</span> threading<span style="color: #555555">.</span>Thread(target<span style="color: #555555">=</span>send_command)
command_thread<span style="color: #555555">.</span>setDaemon <span style="color: #555555">=</span> <span style="color: #336666">True</span>
command_thread<span style="color: #555555">.</span>start()

image <span style="color: #555555">=</span> np<span style="color: #555555">.</span>zeros((<span style="color: #FF6600">320</span>, <span style="color: #FF6600">240</span>), dtype<span style="color: #555555">=</span>np<span style="color: #555555">.</span>uint8)
t <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
turn_p <span style="color: #555555">=</span> turn

<span style="color: #006699; font-weight: bold">while</span> code_running:
    <span style="color: #006699; font-weight: bold">try</span>:
        surf <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>Surface((image<span style="color: #555555">.</span>shape[<span style="color: #FF6600">0</span>], image<span style="color: #555555">.</span>shape[<span style="color: #FF6600">1</span>]))	
        pygame<span style="color: #555555">.</span>surfarray<span style="color: #555555">.</span>blit_array(surf, image<span style="color: #555555">.</span>astype(np<span style="color: #555555">.</span>int))
        rect1 <span style="color: #555555">=</span> surf<span style="color: #555555">.</span>get_rect()
        surf <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>transform<span style="color: #555555">.</span>rotate(surf, <span style="color: #FF6600">90</span>)
        rect1<span style="color: #555555">.</span>x <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
        rect1<span style="color: #555555">.</span>y <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
        screen<span style="color: #555555">.</span>blit(surf, rect1)
        my_font_hud <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>font<span style="color: #555555">.</span>Font(<span style="color: #336666">None</span>,<span style="color: #FF6600">8</span>)
        my_text_hud <span style="color: #555555">=</span> <span style="color: #CC3300">&#39;t:&#39;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(turn)<span style="color: #555555">+</span><span style="color: #CC3300">&#39; h:&#39;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(h)<span style="color: #555555">+</span><span style="color: #CC3300">&#39; r:&#39;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(r)<span style="color: #555555">+</span><span style="color: #CC3300">&#39; p:&#39;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(p)
        text_surface_hud <span style="color: #555555">=</span> my_font<span style="color: #555555">.</span>render(my_text_hud,<span style="color: #336666">True</span>,(<span style="color: #FF6600">50</span>,<span style="color: #FF6600">255</span>,<span style="color: #FF6600">50</span>))
        text_surface_hud <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>transform<span style="color: #555555">.</span>rotate(text_surface_hud,<span style="color: #FF6600">180</span>)
        rect <span style="color: #555555">=</span> text_surface_hud<span style="color: #555555">.</span>get_rect(center<span style="color: #555555">=</span>(<span style="color: #FF6600">160</span>, <span style="color: #FF6600">220</span>))	
        screen<span style="color: #555555">.</span>blit(text_surface_hud,rect)	
        <span style="color: #006699; font-weight: bold">if</span>(turn_p <span style="color: #555555">!=</span> turn):
            
            t <span style="color: #555555">=</span> time<span style="color: #555555">.</span>time() <span style="color: #555555">+</span> <span style="color: #FF6600">2</span>
            turn_p <span style="color: #555555">=</span> turn
            
        <span style="color: #006699; font-weight: bold">if</span> time<span style="color: #555555">.</span>time() <span style="color: #555555">&lt;</span> t:
            <span style="color: #006699; font-weight: bold">if</span> turn <span style="color: #555555">==</span> <span style="color: #336666">True</span>:
                my_text <span style="color: #555555">=</span> <span style="color: #CC3300">&#39;Control Enabled!&#39;</span>
            <span style="color: #006699; font-weight: bold">else</span>:
                my_text <span style="color: #555555">=</span> <span style="color: #CC3300">&#39;Control Disabled!&#39;</span>
            text_surface <span style="color: #555555">=</span> my_font<span style="color: #555555">.</span>render(my_text,<span style="color: #336666">True</span>,(<span style="color: #FF6600">255</span>,<span style="color: #FF6600">0</span>,<span style="color: #FF6600">255</span>))
            text_surface <span style="color: #555555">=</span> pygame<span style="color: #555555">.</span>transform<span style="color: #555555">.</span>rotate(text_surface,<span style="color: #FF6600">180</span>)
            rect <span style="color: #555555">=</span> text_surface<span style="color: #555555">.</span>get_rect(center<span style="color: #555555">=</span>(<span style="color: #FF6600">160</span>, <span style="color: #FF6600">120</span>))		 
            screen<span style="color: #555555">.</span>blit(text_surface,rect)
        pygame<span style="color: #555555">.</span>display<span style="color: #555555">.</span>flip()
    <span style="color: #006699; font-weight: bold">except</span> <span style="color: #CC0000; font-weight: bold">KeyboardInterrupt</span>:
        code_running <span style="color: #555555">=</span> <span style="color: #336666">False</span>
        
GPIO<span style="color: #555555">.</span>cleanup()
sys<span style="color: #555555">.</span>exit(<span style="color: #FF6600">0</span>)
</pre></td></tr></table></div>

</details>

<p style="text-align: left;padding: 0px 30px;">
The below files are modules we made testing the sensor and robot. They were made into functions and classes and imported to main files
for usage. This shows the modularity of our code.</p>

<!-- HTML generated using hilite.me --><div ALIGN=LEFT style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0099FF; font-style: italic"># Robot.py</span>
<span style="color: #0099FF; font-style: italic"># 12/7/2018 </span>
<span style="color: #0099FF; font-style: italic"># Xiaoyu Yan (xy97) and Ji Wu (jw2473)</span>
<span style="color: #0099FF; font-style: italic"># Final Project - Telepresence Vehicle</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Robot class for controling the robot by setting the timings for</span>
<span style="color: #0099FF; font-style: italic"># the GPIO pins. We also decode control messages from the basestation. </span>
<span style="color: #0099FF; font-style: italic"># </span>
</pre></div>
    
<details ALIGN=LEFT><summary><I>Click to see Robot.py</I></summary>
<!-- HTML generated using hilite.me --><div style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">RPi.GPIO</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">GPIO</span> 
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">time</span>

<span style="color: #006699; font-weight: bold">class</span> <span style="color: #00AA88; font-weight: bold">Robot</span>:
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Initializes the two servos using RPi.GPIO library to control GPIO. </span>
<span style="color: #CC3300; font-style: italic">    Handles the timing of the servos and sets the speed and rotation </span>
<span style="color: #CC3300; font-style: italic">    directions of the robot</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    
    LEFT_SERVO_PIN <span style="color: #555555">=</span> <span style="color: #FF6600">6</span>
    RIGHT_SERVO_PIN <span style="color: #555555">=</span> <span style="color: #FF6600">13</span>
    STOP_T  <span style="color: #555555">=</span> <span style="color: #FF6600">0.0015</span> 
    CLKW_T  <span style="color: #555555">=</span> <span style="color: #FF6600">0.0013</span>
    CCLKW_T <span style="color: #555555">=</span> <span style="color: #FF6600">0.0017</span>
    DOWN_T  <span style="color: #555555">=</span> <span style="color: #FF6600">0.02</span>
    STOP_DC <span style="color: #555555">=</span> STOP_T<span style="color: #555555">/</span>(STOP_T<span style="color: #555555">+</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span> <span style="color: #0099FF; font-style: italic">#cycle in percentage</span>
    STOP_FREQ <span style="color: #555555">=</span> <span style="color: #FF6600">1</span><span style="color: #555555">/</span>(STOP_T<span style="color: #555555">+</span>DOWN_T)

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">__init__</span>(<span style="color: #336666">self</span>):
        GPIO<span style="color: #555555">.</span>setmode(GPIO<span style="color: #555555">.</span>BCM)
        GPIO<span style="color: #555555">.</span>setup(<span style="color: #336666">self</span><span style="color: #555555">.</span>LEFT_SERVO_PIN, GPIO<span style="color: #555555">.</span>OUT)
        GPIO<span style="color: #555555">.</span>setup(<span style="color: #336666">self</span><span style="color: #555555">.</span>RIGHT_SERVO_PIN, GPIO<span style="color: #555555">.</span>OUT)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_speed <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_T
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_speed  <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_T
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo <span style="color: #555555">=</span> GPIO<span style="color: #555555">.</span>PWM(<span style="color: #336666">self</span><span style="color: #555555">.</span>LEFT_SERVO_PIN, <span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_FREQ)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo <span style="color: #555555">=</span> GPIO<span style="color: #555555">.</span>PWM(<span style="color: #336666">self</span><span style="color: #555555">.</span>RIGHT_SERVO_PIN, <span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_FREQ)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>start(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>start(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">stop</span>(<span style="color: #336666">self</span>):
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_FREQ)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_FREQ)
    
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">forward</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;Moving forward&quot;</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">left</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;Moving left&quot;</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))
    
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">right</span>(<span style="color: #336666">self</span>):
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;Moving right&quot;</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeDutyCycle(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T<span style="color: #555555">+</span><span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T))

    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">set_speed</span>(<span style="color: #336666">self</span>, interval1, interval2):
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #336666">str</span>(interval1) <span style="color: #555555">+</span> <span style="color: #CC3300">&#39; &#39;</span> <span style="color: #555555">+</span> <span style="color: #336666">str</span>(interval2))
        <span style="color: #006699; font-weight: bold">if</span> interval1 <span style="color: #555555">!=-</span><span style="color: #FF6600">1</span>:
            <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeDutyCycle(interval1<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T<span style="color: #555555">+</span>interval1)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T<span style="color: #555555">+</span>interval1))
        <span style="color: #006699; font-weight: bold">if</span> interval1 <span style="color: #555555">!=</span> <span style="color: #555555">-</span><span style="color: #FF6600">1</span>:
            <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeDutyCycle(interval2<span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T<span style="color: #555555">+</span>interval2)<span style="color: #555555">*</span><span style="color: #FF6600">100</span>)
            <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>ChangeFrequency(<span style="color: #FF6600">1</span><span style="color: #555555">/</span>(<span style="color: #336666">self</span><span style="color: #555555">.</span>DOWN_T<span style="color: #555555">+</span>interval2))
    
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">command</span>(<span style="color: #336666">self</span>, input_str):
        <span style="color: #CC3300; font-style: italic">&#39;&#39;&#39;</span>
<span style="color: #CC3300; font-style: italic">        Decodes message from the base station</span>
<span style="color: #CC3300; font-style: italic">        Values_List = [Valid,turn,heading,roll,pitch] </span>
<span style="color: #CC3300; font-style: italic">        Parameter input_str: string of commands sent through UDP</span>
<span style="color: #CC3300; font-style: italic">        Moves robot if turn is 1</span>
<span style="color: #CC3300; font-style: italic">        Stops robot if turn or valid is 0</span>
<span style="color: #CC3300; font-style: italic">        Decodes the robot speed and direction based on heading and</span>
<span style="color: #CC3300; font-style: italic">        pitch</span>
<span style="color: #CC3300; font-style: italic">        &#39;&#39;&#39;</span>
        data <span style="color: #555555">=</span> input_str<span style="color: #555555">.</span>split(<span style="color: #CC3300">&#39;:&#39;</span>)
        valid <span style="color: #555555">=</span> <span style="color: #336666">int</span>(data[<span style="color: #FF6600">0</span>])
        <span style="color: #006699; font-weight: bold">if</span> valid: 
            turn <span style="color: #555555">=</span> <span style="color: #336666">int</span>(data[<span style="color: #FF6600">1</span>])
            <span style="color: #006699; font-weight: bold">if</span> turn:
                h <span style="color: #555555">=</span> <span style="color: #336666">float</span>(data[<span style="color: #FF6600">2</span>])
                r <span style="color: #555555">=</span> <span style="color: #336666">float</span>(data[<span style="color: #FF6600">3</span>])
                p <span style="color: #555555">=</span> <span style="color: #336666">float</span>(data[<span style="color: #FF6600">4</span>])
                
                <span style="color: #006699; font-weight: bold">if</span> r<span style="color: #555555">&gt;</span><span style="color: #FF6600">180</span>:
                    r<span style="color: #555555">-=</span><span style="color: #FF6600">360</span>
                <span style="color: #006699; font-weight: bold">elif</span> r<span style="color: #555555">&lt;-</span><span style="color: #FF6600">180</span>:
                    r<span style="color: #555555">+=</span><span style="color: #FF6600">360</span>
                <span style="color: #006699; font-weight: bold">if</span> p<span style="color: #555555">&gt;</span><span style="color: #FF6600">180</span>:
                    p<span style="color: #555555">-=</span><span style="color: #FF6600">360</span>
                <span style="color: #006699; font-weight: bold">elif</span> p<span style="color: #555555">&lt;-</span><span style="color: #FF6600">180</span>:
                    p<span style="color: #555555">+=</span><span style="color: #FF6600">360</span>
                
                threshold <span style="color: #555555">=</span> <span style="color: #FF6600">5</span>
                
                <span style="color: #006699; font-weight: bold">if</span> r<span style="color: #555555">&lt;</span>threshold <span style="color: #000000; font-weight: bold">and</span> r<span style="color: #555555">&gt;-</span>threshold:
                    r <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
                <span style="color: #006699; font-weight: bold">if</span> p<span style="color: #555555">&lt;</span>threshold <span style="color: #000000; font-weight: bold">and</span> p<span style="color: #555555">&gt;-</span>threshold:
                    p <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
                
                roll_max <span style="color: #555555">=</span> <span style="color: #FF6600">50</span>
                roll_min <span style="color: #555555">=</span> <span style="color: #555555">-</span><span style="color: #FF6600">50</span>
                pitch_max <span style="color: #555555">=</span> <span style="color: #FF6600">50</span>
                pitch_min <span style="color: #555555">=</span> <span style="color: #555555">-</span><span style="color: #FF6600">50</span>
                <span style="color: #006699; font-weight: bold">if</span> r<span style="color: #555555">&lt;</span>roll_min:
                    roll <span style="color: #555555">=</span> roll_min
                <span style="color: #006699; font-weight: bold">elif</span> r<span style="color: #555555">&gt;</span>roll_max:
                    roll <span style="color: #555555">=</span> roll_max
                <span style="color: #006699; font-weight: bold">else</span>:
                    roll <span style="color: #555555">=</span> r
                <span style="color: #006699; font-weight: bold">if</span> p<span style="color: #555555">&lt;</span>pitch_min:
                    pitch <span style="color: #555555">=</span> pitch_min
                <span style="color: #006699; font-weight: bold">elif</span> p<span style="color: #555555">&gt;</span>pitch_max:
                    pitch <span style="color: #555555">=</span> pitch_max
                <span style="color: #006699; font-weight: bold">else</span>:
                    pitch <span style="color: #555555">=</span> p
                
                rslope <span style="color: #555555">=</span> <span style="color: #FF6600">0.0001</span><span style="color: #555555">/</span>roll_max
                pslope <span style="color: #555555">=</span> <span style="color: #FF6600">2</span><span style="color: #555555">*</span>rslope
                
                left <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>left_speed <span style="color: #555555">+</span> rslope<span style="color: #555555">*</span>roll <span style="color: #555555">-</span> pslope <span style="color: #555555">*</span> pitch
                right <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>right_speed <span style="color: #555555">+</span> rslope<span style="color: #555555">*</span>roll <span style="color: #555555">+</span> pslope <span style="color: #555555">*</span> pitch 
                
                <span style="color: #006699; font-weight: bold">if</span> left<span style="color: #555555">&gt;</span><span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T:
                    left <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>CCLKW_T
                <span style="color: #006699; font-weight: bold">if</span> right<span style="color: #555555">&lt;</span><span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T:
                    right <span style="color: #555555">=</span> <span style="color: #336666">self</span><span style="color: #555555">.</span>CLKW_T
                
                <span style="color: #336666">self</span><span style="color: #555555">.</span>set_speed(left,right)
                <span style="color: #006699; font-weight: bold">print</span> (<span style="color: #CC3300">&quot;left: &quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(left)<span style="color: #555555">+</span><span style="color: #CC3300">&quot; right:&quot;</span><span style="color: #555555">+</span><span style="color: #336666">str</span>(right))
            <span style="color: #006699; font-weight: bold">else</span>:
                <span style="color: #336666">self</span><span style="color: #555555">.</span>stop()
            
        <span style="color: #006699; font-weight: bold">else</span>:
            <span style="color: #336666">self</span><span style="color: #555555">.</span>stop()


    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">calibrate</span>(<span style="color: #336666">self</span>):
        <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">        Calibrates the servo by setting the robot to move in all</span>
<span style="color: #CC3300; font-style: italic">        four directions</span>
<span style="color: #CC3300; font-style: italic">        &quot;&quot;&quot;</span>
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left_servo<span style="color: #555555">.</span>start(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right_servo<span style="color: #555555">.</span>start(<span style="color: #336666">self</span><span style="color: #555555">.</span>STOP_DC)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>stop()
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">5</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>forward()
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">5</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>right()
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">5</span>)
        <span style="color: #336666">self</span><span style="color: #555555">.</span>left()
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">5</span>)
    
    
    <span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">shutdown</span>(<span style="color: #336666">self</span>):
        GPIO<span style="color: #555555">.</span>cleanup()


<span style="color: #006699; font-weight: bold">if</span> __name__<span style="color: #555555">==</span><span style="color: #CC3300">&#39;__main__&#39;</span>:
    
    robot <span style="color: #555555">=</span> Robot()
    
    
    robot<span style="color: #555555">.</span>calibrate()
    robot<span style="color: #555555">.</span>shutdown()
</pre></td></tr></table></div>
      

</details>

<!-- HTML generated using hilite.me --><div ALIGN=LEFT style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #0099FF; font-style: italic"># bno.py</span>
<span style="color: #0099FF; font-style: italic"># 12/7/2018 </span>
<span style="color: #0099FF; font-style: italic"># Xiaoyu Yan (xy97) and Ji Wu (jw2473)</span>
<span style="color: #0099FF; font-style: italic"># Final Project - Telepresence Vehicle</span>
<span style="color: #0099FF; font-style: italic"># Inspired from Adafruit_Python_BNO055 library</span>
<span style="color: #0099FF; font-style: italic">#</span>
<span style="color: #0099FF; font-style: italic"># Handler for reading BNO055 sensor data. We poll the sensor</span>
<span style="color: #0099FF; font-style: italic"># for a combination of values such as sensor heading, roll,</span>
<span style="color: #0099FF; font-style: italic"># and pitch. We also have a set zero function that provides</span>
<span style="color: #0099FF; font-style: italic"># us a way to set the natural position values and send values</span>
<span style="color: #0099FF; font-style: italic"># relative to those natural position values. </span>
<span style="color: #0099FF; font-style: italic"># </span>
</pre></div>
    
<details ALIGN=LEFT><summary><I>Click to see bno.py</I></summary>
<!-- HTML generated using hilite.me --><div style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">logging</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">sys</span>
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">time</span>

<span style="color: #006699; font-weight: bold">from</span> <span style="color: #00CCFF; font-weight: bold">Adafruit_BNO055</span> <span style="color: #006699; font-weight: bold">import</span> BNO055
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #00CCFF; font-weight: bold">RPi.GPIO</span> <span style="color: #006699; font-weight: bold">as</span> <span style="color: #00CCFF; font-weight: bold">GPIO</span>
GPIO<span style="color: #555555">.</span>setmode(GPIO<span style="color: #555555">.</span>BCM)
GPIO<span style="color: #555555">.</span>setup(<span style="color: #FF6600">17</span>, GPIO<span style="color: #555555">.</span>IN, pull_up_down<span style="color: #555555">=</span>GPIO<span style="color: #555555">.</span>PUD_UP)

is_calibrating <span style="color: #555555">=</span> <span style="color: #336666">False</span>
zero_heading <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
zero_roll <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
zero_pitch <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>
bno <span style="color: #555555">=</span> <span style="color: #FF6600">0</span>

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">GPIO17_callback</span>(channel):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    interrupt handler for GPIO17; button on piTFT</span>
<span style="color: #CC3300; font-style: italic">    Changes to whether we are calibrating or not</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">print</span> (<span style="color: #CC3300">&quot;in interrupt 17&quot;</span>)
    <span style="color: #006699; font-weight: bold">global</span> is_calibrating
    is_calibrating <span style="color: #555555">=</span> <span style="color: #000000; font-weight: bold">not</span> is_calibrating

GPIO<span style="color: #555555">.</span>add_event_detect(<span style="color: #FF6600">17</span>, GPIO<span style="color: #555555">.</span>FALLING, callback<span style="color: #555555">=</span>GPIO17_callback, bouncetime<span style="color: #555555">=</span><span style="color: #FF6600">300</span>)

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">calibrate</span>(bno):
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Set up the natural position the sensor values by setting the global zero_heading, </span>
<span style="color: #CC3300; font-style: italic">    zero_roll and zero_pitch values. These are the natural position values.</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;CALIBRATING&quot;</span>)
    <span style="color: #006699; font-weight: bold">global</span> zero_heading, zero_roll, zero_pitch
    <span style="color: #006699; font-weight: bold">while</span> (is_calibrating):
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;CALIBRATING&quot;</span>)
        <span style="color: #0099FF; font-style: italic">#bno.set_calibration(bno.get_calibration())</span>

        zero_heading, zero_roll, zero_pitch <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>read_euler()
        sys, gyro, accel, mag <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>get_calibration_status()
        <span style="color: #0099FF; font-style: italic"># Print everything out.</span>
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Heading={0:0.2F} Roll={1:0.2F} Pitch={2:0.2F}</span><span style="color: #CC3300; font-weight: bold">\t</span><span style="color: #CC3300">Sys_cal={3} </span><span style="color: #CC3300; font-weight: bold">\</span>
<span style="color: #CC3300">        Gyro_cal={4} Accel_cal={5} Mag_cal={6}&#39;</span><span style="color: #555555">.</span>format(
                zero_heading, zero_roll, zero_pitch, sys, gyro, accel, mag))
        time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">1</span>)
    
    
<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">bno_init</span>():
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Initializes the BNO055 sensor. Handles when BNO connection fails.</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">global</span> bno
    bno <span style="color: #555555">=</span> BNO055<span style="color: #555555">.</span>BNO055(serial_port<span style="color: #555555">=</span><span style="color: #CC3300">&#39;/dev/serial0&#39;</span>, rst<span style="color: #555555">=</span><span style="color: #FF6600">18</span>)

    <span style="color: #0099FF; font-style: italic">#if len(sys.argv) == 2 and sys.argv[1].lower() == &#39;-v&#39;:</span>
    <span style="color: #0099FF; font-style: italic">#   logging.basicConfig(level=logging.DEBUG)</span>
    <span style="color: #006699; font-weight: bold">while</span> <span style="color: #336666">True</span>:
        <span style="color: #006699; font-weight: bold">try</span>:
            <span style="color: #006699; font-weight: bold">if</span> <span style="color: #000000; font-weight: bold">not</span> bno<span style="color: #555555">.</span>begin():
                <span style="color: #006699; font-weight: bold">raise</span> <span style="color: #CC0000; font-weight: bold">RuntimeError</span>(<span style="color: #CC3300">&#39;Failed to initialize BNO055! Is the sensor connected?&#39;</span>)    
            status, self_test, error <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>get_system_status()
            <span style="color: #006699; font-weight: bold">break</span>
        <span style="color: #006699; font-weight: bold">except</span> <span style="color: #CC0000; font-weight: bold">Exception</span> <span style="color: #006699; font-weight: bold">as</span> e:
            <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&quot;error :{}&quot;</span><span style="color: #555555">.</span>format(e))
            time<span style="color: #555555">.</span>sleep(<span style="color: #FF6600">0.5</span>)
        
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;System status: {0}&#39;</span><span style="color: #555555">.</span>format(status))
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Self test result (0x0F is normal): 0x{0:02X}&#39;</span><span style="color: #555555">.</span>format(self_test))
    <span style="color: #0099FF; font-style: italic"># Print out an error if system status is in error mode.</span>
    <span style="color: #006699; font-weight: bold">if</span> status <span style="color: #555555">==</span> <span style="color: #FF6600">0x01</span>:
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;System error: {0}&#39;</span><span style="color: #555555">.</span>format(error))
        <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;See datasheet section 4.3.59 for the meaning.&#39;</span>)

    <span style="color: #0099FF; font-style: italic"># Print BNO055 software revision and other diagnostic data.</span>
    sw, bl, accel, mag, gyro <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>get_revision()
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Software version:   {0}&#39;</span><span style="color: #555555">.</span>format(sw))
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Bootloader version: {0}&#39;</span><span style="color: #555555">.</span>format(bl))
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Accelerometer ID:   0x{0:02X}&#39;</span><span style="color: #555555">.</span>format(accel))
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Magnetometer ID:    0x{0:02X}&#39;</span><span style="color: #555555">.</span>format(mag))
    <span style="color: #006699; font-weight: bold">print</span>(<span style="color: #CC3300">&#39;Gyroscope ID:       0x{0:02X}</span><span style="color: #CC3300; font-weight: bold">\n</span><span style="color: #CC3300">&#39;</span><span style="color: #555555">.</span>format(gyro))
        

<span style="color: #006699; font-weight: bold">def</span> <span style="color: #CC00FF">bno_poll</span>():
    <span style="color: #CC3300; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #CC3300; font-style: italic">    Polls from BNO and also checks calibration values</span>
<span style="color: #CC3300; font-style: italic">    &quot;&quot;&quot;</span>
    <span style="color: #006699; font-weight: bold">if</span> is_calibrating:
        calibrate(bno)
    
    <span style="color: #0099FF; font-style: italic"># Read the Euler angles for heading, roll, pitch (all in degrees).</span>
    heading, roll, pitch <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>read_euler()
    <span style="color: #0099FF; font-style: italic"># Read the calibration status, 0=uncalibrated and 3=fully calibrated.</span>
    sys, gyro, accel, mag <span style="color: #555555">=</span> bno<span style="color: #555555">.</span>get_calibration_status()
    <span style="color: #0099FF; font-style: italic"># Print everything out.</span>
    <span style="color: #0099FF; font-style: italic">#print(&#39;Heading={0:0.2F} Roll={1:0.2F} Pitch={2:0.2F}\tSys_cal={3} \</span>
    <span style="color: #0099FF; font-style: italic"># Gyro_cal={4} Accel_cal={5} Mag_cal={6}&#39;.format(</span>
        <span style="color: #0099FF; font-style: italic"># heading, roll, pitch, sys, gyro, accel, mag))</span>
    D_H <span style="color: #555555">=</span> heading<span style="color: #555555">-</span>zero_heading
    D_R <span style="color: #555555">=</span> roll<span style="color: #555555">-</span>zero_roll
    D_P <span style="color: #555555">=</span> pitch<span style="color: #555555">-</span>zero_pitch
    <span style="color: #0099FF; font-style: italic">#print (&quot;D_H = {0:0.2F} D_R = {1:0.2F} D_P={2:0.2F}&quot;.format(</span>
    <span style="color: #0099FF; font-style: italic">#D_H, D_R, D_P))</span>
    <span style="color: #006699; font-weight: bold">return</span> (D_H, D_R, D_P)
</pre></td></tr></table></div>
      
</details>

           
    </div>

<hr id='dist'>
    <div class="row" style="text-align:center;">
          <h2>Work Distribution</h2>
          <div style="text-align:center;">
              <img class="img-rounded" src="pics/IMG_4231.JPG" alt="Generic placeholder image" style="width:80%;">
              <h4>Project group picture</h4>
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/headshot-Xiaoyu.PNG" alt="Generic placeholder image" width="240" height="240">
              <h3>Xiaoyu Yan (xy97)</h3>
              <p class="lead">xy97@cornell.edu</p>
              <p>Worked on sensor, vehicle controls and bluetooth communications.</p>
          </div>
          <div class="col-md-6" style="font-size:16px">
              <img class="img-rounded" src="pics/jw_selfie.PNG" alt="Generic placeholder image" width="240" height="240">
              <h3>Ji Wu</h3>
              <p class="lead">jw2473cornell.edu</p>
              <p>Worked on camera capture to streaming and developed vehicle control equation</p>
          </div>
      </div>

    <hr>
      <div style="font-size:18px">
          <h2>Parts List</h2>
          <style>
                table, th, td {
                    border: 1px solid rgb(7, 00, 255);
                }
            </style>        
            <table align="center">
            <tr>
                <th style="background-color: yellow">Name</th>
                <th style="background-color: yellow">Quanitiy</th>
                <th style="background-color: yellow">Price (US$)</th>
                <th style="background-color: yellow">Link</th>

            </tr>
            <tr>
                <td>Raspberry Pi 3b</td>
                <td >2</td>
                <td >35 (not including 1 provided by lab)</td>
                <td ><a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">link</a></td>
                
            </tr>
            <tr>
                <td>Raspberry Pi Camera V2</td>
                <td>1</td>
                <td>25</td>
                <td ><a href="https://www.raspberrypi.org/products/camera-module-v2/">link</a></td>
            </tr>
            <tr>
                <td>BNO055 Absolute Orientation Sensor   </td>
                <td>1</td>
                <td>34.95</td>
                <td ><a href="https://www.adafruit.com/product/2472">link</a></td>
            </tr>
            <tr>
                <td>Wires, resistors, breadboards, SD cards, servos</td>
                <td>some, some, 2, 2, 2</td>
                <td>Provided by lab</td>
                <td>Provided by lab</td>
            </tr>
            <tr>
                <td>Total</td>
                <td></td>
                <td>94.95</td>
               
                <td></td>

            </tr>
            </table>
      </div>
      <hr>
      <hr id='Acknowledge'>
      <div style="font-size:16px">
          <h2>References</h2>
          <p ALIGN=LEFT> Here are some references for the final project. We did a lot of research on the bluetooth and Pi camera and 
              plausiblity of our vision. 

          </p>
          <ol>
             <li>   <a href="https://pinout.xyz/">RPi Pins layout</a></li>
          <li><a href="https://sourceforge.net/p/raspberry-gpio-python/wiki/Home/">R-Pi GPIO Documentation</a></li>
         <li> <a href="https://picamera.readthedocs.io/">PiCamera Documentation</a><br></li>
         <li> <a href="https://learn.adafruit.com/bno055-absolute-orientation-sensor-with-raspberry-pi-and-beaglebone-black/hardware">
            BNO055 RPi Serial Communication Setup and Library</a><br></li>
         <li> <a href="https://github.com/adafruit/Adafruit_Python_BNO055">
            BNO055 Python Library</a><br></li>
            <li> <a href="https://www.parallax.com/sites/default/files/downloads/900-00008-Continuous-Rotation-Servo-Documentation-v2.2.pdf">
                Continuous Rotation Servo Documentation</a><br></li>  
                <li>   <a href="http://www.pygame.org/docs/">Pygame Documentation</a></li>
                <li>   <a href="https://docs.python.org/2/library/socket.html">Python Socket Documentation</a></li>
                <li>   <a href="https://bluedot.readthedocs.io/en/latest/btcommapi.html">Bluedot Communication Documentation</a></li>
                <li>   <a href="https://lifehacker.com/everything-you-need-to-set-up-bluetooth-on-the-raspberr-1768482065">Setting Up Bluetooth on RPi</a></li>

          </ol>
          
          
      </div>
      <div style="font-size:16px">
          <h2>Acknowledgements</h2>
          <p ALIGN=LEFT> Special thanks to Prof. Skovira and the TA staffs for helping us during the labs and final project sections
              For this project, lab 1, 2, and 3 allowed us to easily set up the PiTFT and Pygame GUI on the PiTFT. We obtained
            the background to control the servos from lab 3. Overall, this class was entertaining and we learned a lot about embedded
        operating systems through the Raspberry Pi and using it as a more powerful alternative to microcontroller based 
        embedded systems.</p>
        <a href="http://skovira.ece.cornell.edu/ece5725/">Class Website</a>
      </div>

   

    </div><!-- /.container -->

    <div class="row" style="text-align:center;">
      <br>─▄▒▒▒▒▒▒─▄▒▒▄▒▒─▄▒▒▄▒▒
      <br>─▀▀█▒▒▀──█▒▒▒▒▒─▀█▒▒▒
      <br>───█▒▒───█▒▒█▒▒─▄▒▒█▒▒
      <br>───▀▀────▀▀─▀▀──▀▀─▀▀─
      <br>
        
</div>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!-- <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script> -->
  </body>
</html>
